<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="px-overlay-behavior.html"/>
<link rel="import" href="px-overlay-container.html"/>

<dom-module id="px-overlay-content">
    <template strip-whitespace>
      <slot></slot>
    </template>
  </dom-module>

  <script>
    Polymer({

      is: 'px-overlay-content',
      behaviors: [
        PxOverlayBehavior.sharedProperties
      ],

      properties: {
        _content: Array,
        _container: HTMLElement,
        eventNames: {
          type: Array,
          value: function() { return []; }
        },

        _isAttached: {
          type: Boolean,
          value: false
        },
        hoist: {
          type: Boolean,
          value: true
        }
      },

      observers: [
        '_hoistPropChanged(hoist)'
      ],

      attached: function() {
        // FIXME? is a requestIdleFeedback a good idea? Will modals ever start open?

        // FIXME Polymer 1 fallback
        Polymer.RenderStatus.afterNextRender(this, () => {
          // TODO, what if we have dynamic content, like dom repeat? Need to test
          this._content = Polymer.FlattenedNodesObserver.getFlattenedNodes(this);
          this._isAttached = true;
          this._hoistPropChanged(this.hoist);
        });

      },

      detached: function() {
        this._isAttached = false;

        if(this._container) {
          this._container.detachContent(this);
        }

      },

      hoistOverlay: function() {
        const event = new CustomEvent('px-overlay-attachment-request', {
          bubbles: true,
          composed: true,
          cancelable: true
        });

        this.dispatchEvent(event);

        // If no container responded, create one
        if (!event.defaultPrevented) {
          const elem = document.createElement('px-overlay-container');

          if(this.containerType) {
            elem.setAttribute('container-type', this.containerType);
          }

          document.body.appendChild(elem);

          // FIXME Polymer 1 fallback
          Polymer.RenderStatus.afterNextRender(elem, () => {
            this.dispatchEvent(event);
          });
        }
      },

      _hoistPropChanged: function(hoist) {
        if(!this._isAttached) {
          return;
        }
        if(hoist && !this._container) {
          this.hoistOverlay();
        }

        if(!hoist && this._container) {
          this._container.detachContent(this);
          this._container = undefined;
          this._content.forEach(elem => {
            Polymer.dom(this).appendChild(elem);
          });
        }

      }

    });
  </script>